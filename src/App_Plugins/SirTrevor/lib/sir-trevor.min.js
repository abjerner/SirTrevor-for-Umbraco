/*!
 * Sir Trevor JS v0.3.2
 *
 * Released under the MIT license
 * www.opensource.org/licenses/MIT
 *
 * 2014-03-22
 */
(function(n,t){function e(t){return t instanceof n?t:n(t)}var c=this,i,f,s,h;i=c.SirTrevor={};i.DEBUG=!1;i.SKIP_VALIDATION=!1;i.version="0.3.0";i.LANGUAGE="en";i.DEFAULTS={defaultType:!1,spinner:{className:"st-spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/",errorsContainer:undefined,toMarkdown:{aggresiveHTMLStrip:!1}};i.BlockMixins={};i.Blocks={};i.Formatters={};i.instances=[];i.Events=Eventable;var o=!1,r={bound:[],_bindFunctions:function(){this.bound.length>0&&t.bindAll.apply(null,t.union([this],this.bound))}},u={tagName:"div",className:"sir-trevor__view",attributes:{},$:function(n){return this.$el.find(n)},render:function(){return this},destroy:function(){t.isUndefined(this.stopListening)||this.stopListening();this.$el.remove()},_ensureElement:function(){var i,r,u;this.el?this._setElement(this.el):(i=t.extend({},t.result(this,"attributes")),this.id&&(i.id=this.id),this.className&&(i["class"]=this.className),i.html&&(r=i.html,delete i.html),u=n("<"+this.tagName+">").attr(i),r&&u.html(r),this._setElement(u))},_setElement:function(n){return this.$el=e(n),this.el=this.$el[0],this}};(function(n){function t(n){n.preventDefault()}function i(t){t.originalEvent.dataTransfer.dropEffect="copy";n(t.currentTarget).addClass("st-drag-over");t.preventDefault()}function r(t){n(t.currentTarget).removeClass("st-drag-over");t.preventDefault()}n.fn.dropArea=function(){return this.bind("dragenter",t).bind("dragover",i).bind("dragleave",r),this};n.fn.noDropArea=function(){return this.unbind("dragenter").unbind("dragover").unbind("dragleave"),this};n.fn.caretToEnd=function(){var n,t;return n=document.createRange(),n.selectNodeContents(this[0]),n.collapse(!1),t=window.getSelection(),t.removeAllRanges(),t.addRange(n),this}})(jQuery);f=function(n,i){var u=this,r,f;return r=n&&t.has(n,"constructor")?n.constructor:function(){return u.apply(this,arguments)},t.extend(r,u,i),f=function(){this.constructor=r},f.prototype=u.prototype,r.prototype=new f,n&&t.extend(r.prototype,n),r.__super__=u.prototype,r};i.log=function(n){!t.isUndefined(console)&&i.DEBUG&&console.log(n)};i.Locales={en:{general:{"delete":"Delete?",drop:"Drag __block__ here",paste:"Or paste URL here",upload:"...or choose a file",close:"close",position:"Position",wait:"Please wait...",link:"Enter a link"},errors:{title:"You have the following errors:",validation_fail:"__type__ block is invalid",block_empty:"__name__ must not be empty",type_missing:"You must have a block of type __type__",required_type_empty:"A required block type __type__ is empty",load_fail:"There was a problem loading the contents of the document"},blocks:{text:{title:"Text"},list:{title:"List"},quote:{title:"Quote",credit_field:"Credit"},image:{title:"Image",upload_error:"There was a problem with your upload"},video:{title:"Video"},tweet:{title:"Tweet",fetch_error:"There was a problem fetching your tweet"},embedly:{title:"Embedly",fetch_error:"There was a problem fetching your embed",key_missing:"An Embedly API key must be present"},heading:{title:"Heading"}}}};window.i18n===undefined||window.i18n.init===undefined?(i.log("Using i18n stub"),window.i18n={t:function(n,r){for(var s=n.split(":"),u,o,f=i.Locales[i.LANGUAGE],e=0;e<s.length;e++)o=s[e],t.isUndefined(f[o])||(f=f[o]);return(u=f,!t.isString(u))?"":(u.indexOf("__")>=0&&t.each(r,function(n,t){u=u.replace("__"+t+"__",n)}),u)}}):(i.log("Using i18next"),i18n.init({resStore:i.Locales,fallbackLng:i.LANGUAGE,ns:{namespaces:["general","blocks"],defaultNs:"general"}})),function(n,t,i){function f(n,i){var r=t.createElement(n||"div");for(var u in i)r[u]=i[u];return r}function u(n){for(var t=1,i=arguments.length;t<i;t++)n.appendChild(arguments[t]);return n}function p(n,t,i,r){var u=["opacity",t,~~(n*100),i,r].join("-"),f=.01+i/r*100,o=Math.max(1-(1-n)/t*(100-f),n),s=e.substring(0,e.indexOf("Animation")).toLowerCase(),h=s&&"-"+s+"-"||"";return a[u]||(v.insertRule("@"+h+"keyframes "+u+"{0%{opacity:"+o+"}"+f+"%{opacity:"+n+"}"+(f+.01)+"%{opacity:1}"+(f+t)%100+"%{opacity:"+n+"}100%{opacity:"+o+"}}",0),a[u]=1),u}function s(n,t){var f=n.style,u,r;if(f[t]!==i)return t;for(t=t.charAt(0).toUpperCase()+t.slice(1),r=0;r<l.length;r++)if(u=l[r]+t,f[u]!==i)return u}function r(n,t){for(var i in t)n.style[s(n,i)||i]=t[i];return n}function h(n){for(var u,r,t=1;t<arguments.length;t++){u=arguments[t];for(r in u)n[r]===i&&(n[r]=u[r])}return n}function c(n){for(var t={x:n.offsetLeft,y:n.offsetTop};n=n.offsetParent;)t.x+=n.offsetLeft,t.y+=n.offsetTop;return t}var l=["webkit","Moz","ms","O"],a={},e,v=function(){var n=f("style");return u(t.getElementsByTagName("head")[0],n),n.sheet||n.styleSheet}(),w={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},o=function y(n){if(!this.spin)return new y(n);this.opts=h(n||{},y.defaults,w)};o.defaults={};h(o.prototype,{spin:function(n){this.stop();var i=this,t=i.opts,u=i.el=r(f(0,{className:t.className}),{position:"relative",zIndex:t.zIndex}),l=t.radius+t.length+t.width,o,s;if(n&&(n.insertBefore(u,n.firstChild||null),s=c(n),o=c(u),r(u,{left:(t.left=="auto"?s.x-o.x+(n.offsetWidth>>1):t.left+l)+"px",top:(t.top=="auto"?s.y-o.y+(n.offsetHeight>>1):t.top+l)+"px"})),u.setAttribute("aria-role","progressbar"),i.lines(u,i.opts),!e){var a=0,v=t.fps,h=v/t.speed,y=(1-t.opacity)/(h*t.trail/100),p=h/t.lines;!function w(){var n,r;for(a++,n=t.lines;n;n--)r=Math.max(1-(a+n*p)%h*y,t.opacity),i.opacity(u,t.lines-n,r,t);i.timeout=i.el&&setTimeout(w,~~(1e3/v))}()}return i},stop:function(){var n=this.el;return n&&(clearTimeout(this.timeout),n.parentNode&&n.parentNode.removeChild(n),this.el=i),this},lines:function(n,t){function s(n,u){return r(f(),{position:"absolute",width:t.length+t.width+"px",height:t.width+"px",background:n,boxShadow:u,transformOrigin:"left",transform:"rotate("+~~(360/t.lines*i+t.rotate)+"deg) translate("+t.radius+"px,0)",borderRadius:(t.width>>1)+"px"})}for(var i=0,o;i<t.lines;i++)o=r(f(),{position:"absolute",top:1+~(t.width/2)+"px",transform:t.hwaccel?"translate3d(0,0,0)":"",opacity:t.opacity,animation:e&&p(t.opacity,t.trail,i,t.lines)+" "+1/t.speed+"s linear infinite"}),t.shadow&&u(o,r(s("#000","0 0 4px #000"),{top:"2px"})),u(n,u(o,s(t.color,"0 0 1px rgba(0,0,0,.1)")));return n},opacity:function(n,t,i){t<n.childNodes.length&&(n.childNodes[t].style.opacity=i)}});!function(){function n(n,t){return f("<"+n+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}var t=r(f("group"),{behavior:"url(#default#VML)"});!s(t,"transform")&&t.adj?(v.addRule(".spin-vml","behavior:url(#default#VML)"),o.prototype.lines=function(t,i){function s(){return r(n("group",{coordsize:o+" "+o,coordorigin:-e+" "+-e}),{width:o,height:o})}function h(t,f,o){u(l,u(r(s(),{rotation:360/i.lines*t+"deg",left:~~f}),u(r(n("roundrect",{arcsize:1}),{width:e,height:i.width,left:i.radius,top:-i.width>>1,filter:o}),n("fill",{color:i.color,opacity:i.opacity}),n("stroke",{opacity:0}))))}var e=i.length+i.width,o=2*e,c=-(i.width+i.length)*2+"px",l=r(s(),{position:"absolute",top:c,left:c}),f;if(i.shadow)for(f=1;f<=i.lines;f++)h(f,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(f=1;f<=i.lines;f++)h(f);return u(t,l)},o.prototype.opacity=function(n,t,i,r){var u=n.firstChild;r=r.shadow&&r.lines||0;u&&t+r<u.childNodes.length&&(u=u.childNodes[t+r],u=u&&u.firstChild,u=u&&u.firstChild,u&&(u.opacity=i))}):e=s(t,"animation")}();n.Spinner=o}(window,document);i.editorStore=function(n,r,u){var f,e,o;u=u||{};switch(r){case"create":if(e=t.trim(n.$el.val()),n.dataStore={data:[]},e.length>0)try{o=JSON.parse(e);t.isUndefined(o.data)||(n.dataStore=o)}catch(s){n.errors.push({text:i18n.t("errors:load_fail")});n.renderErrors();i.log("Sorry there has been a problem with parsing the JSON");i.log(s)}break;case"reset":n.dataStore={data:[]};break;case"add":u.data&&(n.dataStore.data.push(u.data),f=n.dataStore);break;case"save":n.$el.val(n.dataStore.data.length>0?JSON.stringify(n.dataStore):"");break;case"read":f=n.dataStore}if(f)return f};i.Submittable=function(n){this.$form=n;this.intialize()};t.extend(i.Submittable.prototype,{intialize:function(){this.$submitBtn=this.$form.find("input[type='submit']");var i=[];t.each(this.$submitBtn,function(t){i.push(n(t).attr("value"))});this.submitBtnTitles=i;this.canSubmit=!0;this.globalUploadCount=0;this._bindEvents()},setSubmitButton:function(n,t){this.$submitBtn.attr("value",t)},resetSubmitButton:function(){t.each(this.$submitBtn,function(t,i){n(t).attr("value",this.submitBtnTitles[i])},this)},onUploadStart:function(){this.globalUploadCount++;i.log("onUploadStart called "+this.globalUploadCount);this.globalUploadCount===1&&this._disableSubmitButton()},onUploadStop:function(){this.globalUploadCount=this.globalUploadCount<=0?0:this.globalUploadCount-1;i.log("onUploadStop called "+this.globalUploadCount);this.globalUploadCount===0&&this._enableSubmitButton()},onError:function(){i.log("onError called");this.canSubmit=!1},_disableSubmitButton:function(n){this.setSubmitButton(null,n||i18n.t("general:wait"));this.$submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton();this.$submitBtn.removeAttr("disabled").removeClass("disabled")},_events:{disableSubmitButton:"_disableSubmitButton",enableSubmitButton:"_enableSubmitButton",setSubmitButton:"setSubmitButton",resetSubmitButton:"resetSubmitButton",onError:"onError",onUploadStart:"onUploadStart",onUploadStop:"onUploadStop"},_bindEvents:function(){t.forEach(this._events,function(n,t){i.EventBus.on(t,this[n],this)},this)}});i.fileUploader=function(r,u,f,e){var s=[r.blockID,(new Date).getTime(),"raw"].join("-"),o=new FormData;o.append("attachment[name]",u.name);o.append("attachment[file]",u);o.append("attachment[uid]",s);r.resetMessages();var c=function(){i.log("Upload callback called");!t.isUndefined(f)&&t.isFunction(f)&&f.apply(r,arguments)},l=function(){i.log("Upload callback error called");!t.isUndefined(e)&&t.isFunction(e)&&e.apply(r,arguments)},h=n.ajax({url:i.DEFAULTS.uploadUrl,data:o,cache:!1,contentType:!1,processData:!1,dataType:"json",type:"POST"});return r.addQueuedItem(s,h),h.done(c).fail(l).always(t.bind(r.removeQueuedItem,r,s)),h};s=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;t.mixin({isURI:function(n){return s.test(n)},titleize:function(n){return n===null?"":(n=String(n).toLowerCase(),n.replace(/(?:^|\s|-)\S/g,function(n){return n.toUpperCase()}))},classify:function(n){return t.titleize(String(n).replace(/[\W_]/g," ")).replace(/\s/g,"")},classifyList:function(n){return t.map(n,function(n){return t.classify(n)})},capitalize:function(n){return n.charAt(0).toUpperCase()+n.substring(1).toLowerCase()},underscored:function(n){return t.trim(n).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},trim:function(n){return n.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},reverse:function(n){return n.split("").reverse().join("")},flattern:function(n){var i={};return t.each(n,function(r,u){i[t.isArray(n)?r:u]=!0}),i},to_slug:function(n){return n.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}});i.toHTML=function(n,r){var u,f,s,e,o;r=t.classify(r);u=n;f=r==="Text";t.isUndefined(f)&&(f=!1);f&&(u="<div>"+u);u=u.replace(/\[([^\]]+)\]\(([^\)]+)\)/gm,function(n,t,i){return"<a href='"+i+"'>"+t.replace(/\r?\n/g,"")+"<\/a>"});u=t.reverse(t.reverse(u).replace(/_(?!\\)((_\\|[^_])*)_(?=$|[^\\])/gm,function(n,t){return">i/<"+t.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">i<"}).replace(/\*\*(?!\\)((\*\*\\|[^\*\*])*)\*\*(?=$|[^\\])/gm,function(n,t){return">b/<"+t.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">b<"}));u=u.replace(/^\> (.+)$/mg,"$1");for(s in i.Formatters)i.Formatters.hasOwnProperty(s)&&(e=i.Formatters[s],!t.isUndefined(e.toHTML)&&t.isFunction(e.toHTML)&&(u=e.toHTML(u)));return i.Blocks.hasOwnProperty(r)&&(o=i.Blocks[r],!t.isUndefined(o.prototype.toHTML)&&t.isFunction(o.prototype.toHTML)&&(u=o.prototype.toHTML(u))),f&&(u=u.replace(/\r?\n\r?\n/gm,"<\/div><div><br><\/div><div>"),u=u.replace(/\r?\n/gm,"<\/div><div>")),u=u.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\r?\n/g,"<br>").replace(/\*\*/,"").replace(/__/,""),u=u.replace(/\\\*/g,"*").replace(/\\\[/g,"[").replace(/\\\]/g,"]").replace(/\\\_/g,"_").replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\\-/g,"-"),f&&(u+="<\/div>"),u};i.toMarkdown=function(n,r){function a(n,i,r){return t.isUndefined(r)&&(r=""),"**"+i.replace(/<(.)?br(.)?>/g,"")+"**"+r}function v(n,i,r){return t.isUndefined(r)&&(r=""),"_"+i.replace(/<(.)?br(.)?>/g,"")+"_"+r}var u,e,o,f,s,l,h,c;for(r=t.classify(r),u=n,u=u.replace(/&nbsp;/g," "),u=u.replace(/( class=(")?Mso[a-zA-Z]+(")?)/g,"").replace(/<!--(.*?)-->/g,"").replace(/\/\*(.*?)\*\//g,"").replace(/<(\/)*(meta|link|span|\\?xml:|st1:|o:|font)(.*?)>/gi,""),e=["style","script","applet","embed","noframes","noscript"],f=0;f<e.length;f++)o=new RegExp("<"+e[f]+".*?"+e[f]+"(.*?)>","gi"),u=u.replace(o,"");for(u=u.replace(/\*/g,"\\*").replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\_/g,"\\_").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\-/g,"\\-"),s=["em","i","strong","b"],f=0;f<s.length;f++)o=new RegExp("<"+s[f]+"><br><\/"+s[f]+">","gi"),u=u.replace(o,"<br>");u=u.replace(/<(\w+)(?:\s+\w+="[^"]+(?:"\$[^"]+"[^"]+)?")*>\s*<\/\1>/gim,"").replace(/\n/mg,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/gim,function(n,t,i){return"["+i.trim().replace(/<(.)?br(.)?>/g,"")+"]("+t+")"}).replace(/<strong>(?:\s*)(.*?)(\s)*?<\/strong>/gim,a).replace(/<b>(?:\s*)(.*?)(\s*)?<\/b>/gim,a).replace(/<em>(?:\s*)(.*?)(\s*)?<\/em>/gim,v).replace(/<i>(?:\s*)(.*?)(\s*)?<\/i>/gim,v);for(l in i.Formatters)i.Formatters.hasOwnProperty(l)&&(h=i.Formatters[l],!t.isUndefined(h.toMarkdown)&&t.isFunction(h.toMarkdown)&&(u=h.toMarkdown(u)));return u=u.replace(/([^<>]+)(<div>)/g,"$1\n$2").replace(/<div><div>/g,"\n<div>").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n").replace(/<\/p>/g,"\n\n").replace(/<(.)?br(.)?>/g,"\n").replace(/&lt;/g,"<").replace(/&gt;/g,">"),i.Blocks.hasOwnProperty(r)&&(c=i.Blocks[r],!t.isUndefined(c.prototype.toMarkdown)&&t.isFunction(c.prototype.toMarkdown)&&(u=c.prototype.toMarkdown(u))),i.DEFAULTS.toMarkdown.aggresiveHTMLStrip?u.replace(/<\/?[^>]+(>|$)/g,""):u.replace(/<(?=\S)\/?[^>]+(>|$)/ig,"")};i.EventBus=t.extend({},i.Events);i.BlockMixins.Ajaxable={mixinName:"Ajaxable",ajaxable:!0,initializeAjaxable:function(){this._queued=[]},addQueuedItem:function(n,t){i.log("Adding queued item for "+this.blockID+" called "+n);i.EventBus.trigger("onUploadStart",this.blockID);this._queued.push({name:n,deffered:t})},removeQueuedItem:function(n){i.log("Removing queued item for "+this.blockID+" called "+n);i.EventBus.trigger("onUploadStop",this.blockID);this._queued=t.reject(this._queued,function(t){return t.name==n})},hasItemsInQueue:function(){return this._queued.length>0},resolveAllInQueue:function(){t.each(this._queued,function(n){i.log("Aborting queued request: "+n.name);n.deffered.abort()},this)}};i.BlockMixins.Controllable={mixinName:"Controllable",initializeControllable:function(){i.log("Adding controllable to block "+this.blockID);this.$control_ui=n("<div>",{"class":"st-block__control-ui"});t.each(this.controls,function(n,i){this.addUiControl(i,t.bind(n,this))},this);this.$inner.append(this.$control_ui)},getControlTemplate:function(t){return n("<a>",{"data-icon":t,"class":"st-icon st-block-control-ui-btn st-block-control-ui-btn--"+t})},addUiControl:function(n,t){this.$control_ui.append(this.getControlTemplate(n));this.$control_ui.on("click",".st-block-control-ui-btn--"+n,t)}};i.BlockMixins.Droppable={mixinName:"Droppable",valid_drop_file_types:["File","Files","text/plain","text/uri-list"],initializeDroppable:function(){i.log("Adding droppable to block "+this.blockID);this.drop_options=t.extend({},i.DEFAULTS.Block.drop_options,this.drop_options);var r=n(t.template(this.drop_options.html,{block:this}));this.$editor.hide();this.$inputs.append(r);this.$dropzone=r;this.$dropzone.dropArea().bind("drop",t.bind(this._handleDrop,this));this.$inner.addClass("st-block__inner--droppable")},_handleDrop:function(r){r.preventDefault();r=r.originalEvent;var f=n(r.target),u=r.dataTransfer.types;if(f.removeClass("st-dropzone--dragover"),!t.isUndefined(u)&&t.some(u,function(n){return t.include(this.valid_drop_file_types,n)},this))this.onDrop(r.dataTransfer);i.EventBus.trigger("block:content:dropped",this.blockID)}};i.BlockMixins.Fetchable={mixinName:"Fetchable",initializeFetchable:function(){this.withMixin(i.BlockMixins.Ajaxable)},fetch:function(i,r,u){var e=t.uniqueId(this.blockID+"_fetch"),f=n.ajax(i);return this.resetMessages(),this.addQueuedItem(e,f),t.isUndefined(r)||f.done(t.bind(r,this)),t.isUndefined(u)||f.fail(t.bind(u,this)),f.always(t.bind(this.removeQueuedItem,this,e)),f}};i.BlockMixins.Pastable={mixinName:"Pastable",initializePastable:function(){i.log("Adding pastable to block "+this.blockID);this.paste_options=t.extend({},i.DEFAULTS.Block.paste_options,this.paste_options);this.$inputs.append(t.template(this.paste_options.html,this));this.$(".st-paste-block").bind("click",function(){n(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)}};i.BlockMixins.Uploadable={mixinName:"Uploadable",uploadsCount:0,initializeUploadable:function(){i.log("Adding uploadable to block "+this.blockID);this.withMixin(i.BlockMixins.Ajaxable);this.upload_options=t.extend({},i.DEFAULTS.Block.upload_options,this.upload_options);this.$inputs.append(t.template(this.upload_options.html,this))},uploader:function(n,t,r){return i.fileUploader(this,n,t,r)}};i.BlockPositioner=function(){var f="<div class='st-block-positioner__inner'>\n<span class='st-block-positioner__selected-value'><\/span>\n<select class='st-block-positioner__select'><\/select>\n<\/div>",n=function(n,t){this.$block=n;this.instanceID=t;this.total_blocks=0;this._ensureElement();this._bindFunctions();this.initialize()};return t.extend(n.prototype,r,u,{bound:["onBlockCountChange","onSelectChange","toggle","show","hide"],className:"st-block-positioner",visibleClass:"st-block-positioner--is-visible",initialize:function(){this.$el.append(f);this.$select=this.$(".st-block-positioner__select");this.$select.on("change",this.onSelectChange);i.EventBus.on(this.instanceID+":blocks:count_update",this.onBlockCountChange)},onBlockCountChange:function(n){n!=this.total_blocks&&(this.total_blocks=n,this.renderPositionList())},onSelectChange:function(){var n=this.$select.val();n!==0&&(i.EventBus.trigger(this.instanceID+":blocks:change_position",this.$block,n,n==1?"before":"after"),this.toggle())},renderPositionList:function(){for(var t="<option value='0'>"+i18n.t("general:position")+"<\/option>",n=1;n<=this.total_blocks;n++)t+="<option value="+n+">"+n+"<\/option>";this.$select.html(t)},toggle:function(){this.$select.val(0);this.$el.toggleClass(this.visibleClass)},show:function(){this.$el.addClass(this.visibleClass)},hide:function(){this.$el.removeClass(this.visibleClass)}}),n}();i.BlockReorder=function(){var f=function(n){this.$block=n;this.blockID=this.$block.attr("id");this._ensureElement();this._bindFunctions();this.initialize()};return t.extend(f.prototype,r,u,{bound:["onMouseDown","onClick","onDragStart","onDragEnd","onDrag","onDrop"],className:"st-block-ui-btn st-block-ui-btn--reorder st-icon",tagName:"a",attributes:function(){return{html:"reorder",draggable:"true","data-icon":"move"}},initialize:function(){this.$el.bind("mousedown touchstart",this.onMouseDown).bind("click",this.onClick).bind("dragstart",this.onDragStart).bind("dragend touchend",this.onDragEnd).bind("drag touchmove",this.onDrag);this.$block.dropArea().bind("drop",this.onDrop)},onMouseDown:function(){i.EventBus.trigger("block:reorder:down",this.blockID)},onDrop:function(r){r.preventDefault();var f=this.$block,u=r.originalEvent.dataTransfer.getData("text/plain"),e=n("#"+u);t.isUndefined(u)||t.isEmpty(e)||f.attr("id")==u||f.attr("data-instance")!=e.attr("data-instance")||f.after(e);i.EventBus.trigger("block:reorder:dropped",u)},onDragStart:function(t){var r=n(t.currentTarget).parent();t.originalEvent.dataTransfer.setDragImage(this.$block[0],r.position().left,r.position().top);t.originalEvent.dataTransfer.setData("Text",this.blockID);i.EventBus.trigger("block:reorder:dragstart",this.blockID);this.$block.addClass("st-block--dragging")},onDragEnd:function(){i.EventBus.trigger("block:reorder:dragend",this.blockID);this.$block.removeClass("st-block--dragging")},onDrag:function(){},onClick:function(){},render:function(){return this}}),f}();i.BlockDeletion=function(){var n=function(){this._ensureElement();this._bindFunctions()};return t.extend(n.prototype,r,u,{tagName:"a",className:"st-block-ui-btn st-block-ui-btn--delete st-icon",attributes:{html:"delete","data-icon":"bin"}}),n}();h=function(n){var i=n.attr("data-st-name")||n.attr("name");return i||(i="Field"),t.capitalize(i)};i.BlockValidations={errors:[],valid:function(){return this.performValidations(),this.errors.length===0},performValidations:function(){this.resetErrors();var n=this.$(".st-required");t.each(n,this.validateField,this);t.each(this.validations,this.runValidator,this);this.$el.toggleClass("st-block--with-errors",this.errors.length>0)},validations:[],validateField:function(t){t=n(t);var i=t.attr("contenteditable")?t.text():t.val();i.length===0&&this.setError(t,i18n.t("errors:block_empty",{name:h(t)}))},runValidator:function(n){t.isUndefined(this[n])||this[n].call(this)},setError:function(n,t){var i=this.addMessage(t,"st-msg--error");n.addClass("st-error");this.errors.push({field:n,reason:t,msg:i})},resetErrors:function(){t.each(this.errors,function(n){n.field.removeClass("st-error");n.msg.remove()});this.$messages.removeClass("st-block__messages--is-visible");this.errors=[]}};i.BlockStore={blockStorage:{},createStore:function(n){this.blockStorage={type:t.underscored(this.type),data:n||{}}},save:function(){this.toData()},saveAndReturnData:function(){return this.save(),this.blockStorage},saveAndGetData:function(){var n=this.saveAndReturnData();return n.data||n},getData:function(){return this.blockStorage.data},setData:function(n){i.log("Setting data for block "+this.blockID);t.extend(this.blockStorage.data,n||{})},setAndRetrieveData:function(n){return this.setData(n),this.getData()},setAndLoadData:function(n){this.setData(n);this.beforeLoadingData()},toData:function(){},loadData:function(){},beforeLoadingData:function(){i.log("loadData for "+this.blockID);i.EventBus.trigger("block:loadData",this.blockID);this.loadData(this.getData())},_loadData:function(){i.log("_loadData is deprecated and will be removed in the future. Please use beforeLoadingData instead.");this.beforeLoadingData()},checkAndLoadData:function(){t.isEmpty(this.getData())||this.beforeLoadingData()}};i.SimpleBlock=function(){var e=function(n,i){this.createStore(n);this.blockID=t.uniqueId("st-block-");this.instanceID=i;this._ensureElement();this._bindFunctions();this.initialize.apply(this,arguments)};return t.extend(e.prototype,r,i.Events,u,i.BlockStore,{focus:function(){},valid:function(){return!0},className:"st-block",block_template:t.template("<div class='st-block__inner'><%= editor_html %><\/div>"),attributes:function(){return{id:this.blockID,"data-type":this.type,"data-instance":this.instanceID}},title:function(){return t.titleize(this.type.replace(/[\W_]/g," "))},blockCSSClass:function(){return this.blockCSSClass=t.to_slug(this.type),this.blockCSSClass},type:"","class":function(){return t.classify(this.type)},editorHTML:"",initialize:function(){},onBlockRender:function(){},beforeBlockRender:function(){},_setBlockInner:function(){var n=t.result(this,"editorHTML");this.$el.append(this.block_template({editor_html:n}));this.$inner=this.$el.find(".st-block__inner");this.$inner.bind("click mouseover",function(n){n.stopPropagation()})},render:function(){return this.beforeBlockRender(),this._setBlockInner(),this._blockPrepare(),this},_blockPrepare:function(){this._initUI();this._initMessages();this.checkAndLoadData();this.$el.addClass("st-item-ready");this.on("onRender",this.onBlockRender);this.save()},_withUIComponent:function(n,t,i){this.$ui.append(n.render().$el);t&&i&&this.$ui.on("click",t,i)},_initUI:function(){var t=n("<div>",{"class":"st-block__ui"});this.$inner.append(t);this.$ui=t;this._initUIComponents()},_initMessages:function(){var t=n("<div>",{"class":"st-block__messages"});this.$inner.prepend(t);this.$messages=t},addMessage:function(t,i){var r=n("<span>",{html:t,"class":"st-msg "+i});return this.$messages.append(r).addClass("st-block__messages--is-visible"),r},resetMessages:function(){this.$messages.html("").removeClass("st-block__messages--is-visible")},_initUIComponents:function(){this._withUIComponent(new i.BlockReorder(this.$el))}}),e.fn=e.prototype,e.extend=f,e}();i.Block=function(){var r=function(){i.SimpleBlock.apply(this,arguments)},u=["<div class='st-block__ui-delete-controls'>","<label class='st-block__delete-label'>","<%= i18n.t('general:delete') %>","<\/label>","<a class='st-block-ui-btn st-block-ui-btn--confirm-delete st-icon' data-icon='tick'><\/a>","<a class='st-block-ui-btn st-block-ui-btn--deny-delete st-icon' data-icon='close'><\/a>","<\/div>"].join("\n"),e={html:['<div class="st-block__dropzone">','<span class="st-icon"><%= _.result(block, "icon_name") %><\/span>','<p><%= i18n.t("general:drop", { block: "<span>" + _.result(block, "title") + "<\/span>" }) %>',"<\/p><\/div>"].join("\n"),re_render_on_reorder:!1},o={html:['<input type="text" placeholder="<%= i18n.t("general:paste") %>"',' class="st-block__paste-input st-paste-block">'].join("")},s={html:['<div class="st-block__upload-container">','<input type="file" type="st-file-upload">','<button class="st-upload-btn"><%= i18n.t("general:upload") %><\/button>',"<\/div>"].join("\n")};return i.DEFAULTS.Block={drop_options:e,paste_options:o,upload_options:s},t.extend(r.prototype,i.SimpleBlock.fn,i.BlockValidations,{bound:["_handleContentPaste","_onFocus","_onBlur","onDrop","onDeleteClick","clearInsertedStyles","getSelectionForFormatter","onBlockRender"],className:"st-block st-icon--add",attributes:function(){return t.extend(i.SimpleBlock.fn.attributes.call(this),{"data-icon-after":"add"})},icon_name:"default",validationFailMsg:function(){return i18n.t("errors:validation_fail",{type:this.title()})},editorHTML:'<div class="st-block__editor"><\/div>',toolbarEnabled:!0,droppable:!1,pastable:!1,uploadable:!1,fetchable:!1,ajaxable:!1,drop_options:{},paste_options:{},upload_options:{},formattable:!0,_previousSelection:"",initialize:function(){},toMarkdown:function(n){return n},toHTML:function(n){return n},withMixin:function(n){if(t.isObject(n)){var i="initialize"+n.mixinName;t.isUndefined(this[i])&&(t.extend(this,n),this[i]())}},render:function(){if(this.beforeBlockRender(),this._setBlockInner(),this.$editor=this.$inner.children().first(),this.droppable||this.pastable||this.uploadable){var t=n("<div>",{"class":"st-block__inputs"});this.$inner.append(t);this.$inputs=t}return this.hasTextBlock&&this._initTextBlocks(),this.droppable&&this.withMixin(i.BlockMixins.Droppable),this.pastable&&this.withMixin(i.BlockMixins.Pastable),this.uploadable&&this.withMixin(i.BlockMixins.Uploadable),this.fetchable&&this.withMixin(i.BlockMixins.Fetchable),this.controllable&&this.withMixin(i.BlockMixins.Controllable),this.formattable&&this._initFormatting(),this._blockPrepare(),this},remove:function(){this.ajaxable&&this.resolveAllInQueue();this.$el.remove()},loading:function(){t.isUndefined(this.spinner)||this.ready();this.spinner=new Spinner(i.DEFAULTS.spinner);this.spinner.spin(this.$el[0]);this.$el.addClass("st--is-loading")},ready:function(){this.$el.removeClass("st--is-loading");t.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},toData:function(){var u,n,r;i.log("toData for "+this.blockID);u=this.$el;n={};this.hasTextBlock()&&(r=this.getTextBlock().html(),r.length>0&&(n.text=i.toMarkdown(r,this.type)));this.$(":input").not(".st-paste-block").length>0&&this.$(":input").each(function(t,i){i.getAttribute("name")&&(n[i.getAttribute("name")]=i.value)});t.isEmpty(n)||this.setData(n)},focus:function(){this.getTextBlock().focus()},blur:function(){this.getTextBlock().blur()},onFocus:function(){this.getTextBlock().bind("focus",this._onFocus)},onBlur:function(){this.getTextBlock().bind("blur",this._onBlur)},_onFocus:function(){this.trigger("blockFocus",this.$el)},_onBlur:function(){},onDrop:function(){},onDeleteClick:function(n){var i,r,f;if(n.preventDefault(),i=function(n){n.preventDefault();this.trigger("removeBlock",this.blockID)},r=function(n){n.preventDefault();this.$el.removeClass("st-block--delete-active");f.remove()},this.isEmpty()){i.call(this,new Event("click"));return}this.$inner.append(t.template(u));this.$el.addClass("st-block--delete-active");f=this.$inner.find(".st-block__ui-delete-controls");this.$inner.on("click",".st-block-ui-btn--confirm-delete",t.bind(i,this)).on("click",".st-block-ui-btn--deny-delete",t.bind(r,this))},pastedMarkdownToHTML:function(n){return i.toHTML(i.toMarkdown(n,this.type),this.type)},onContentPasted:function(n,t){t.html(this.pastedMarkdownToHTML(t[0].innerHTML));this.getTextBlock().caretToEnd()},beforeLoadingData:function(){this.loading();(this.droppable||this.uploadable||this.pastable)&&(this.$editor.show(),this.$inputs.hide());i.SimpleBlock.fn.beforeLoadingData.call(this);this.ready()},_handleContentPaste:function(i){var r=n(i.currentTarget);t.delay(t.bind(this.onContentPasted,this,i,r),0)},_getBlockClass:function(){return"st-block--"+this.className},_initUIComponents:function(){var n=new i.BlockPositioner(this.$el,this.instanceID);this._withUIComponent(n,".st-block-ui-btn--reorder",n.toggle);this._withUIComponent(new i.BlockReorder(this.$el));this._withUIComponent(new i.BlockDeletion,".st-block-ui-btn--delete",this.onDeleteClick);this.onFocus();this.onBlur()},_initFormatting:function(){var n;for(var r in i.Formatters)i.Formatters.hasOwnProperty(r)&&(n=i.Formatters[r],t.isUndefined(n.keyCode)||n._bindToBlock(this.$el))},_initTextBlocks:function(){this.getTextBlock().bind("paste",this._handleContentPaste).bind("keyup",this.getSelectionForFormatter).bind("mouseup",this.getSelectionForFormatter).bind("DOMNodeInserted",this.clearInsertedStyles)},getSelectionForFormatter:function(){t.defer(function(){var n=window.getSelection(),t=n.toString().trim(),r=t===""?"hide":"position";i.EventBus.trigger("formatter:"+r,this)})},clearInsertedStyles:function(n){var t=n.target;t.removeAttribute("style")},hasTextBlock:function(){return this.getTextBlock().length>0},getTextBlock:function(){return t.isUndefined(this.text_block)&&(this.text_block=this.$(".st-text-block")),this.text_block},isEmpty:function(){return t.isEmpty(this.saveAndGetData())}}),r.extend=f,r}();i.Formatter=function(){var n=function(n){this.formatId=t.uniqueId("format-");this._configure(n||{});this.initialize.apply(this,arguments)},i=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];return t.extend(n.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(n){return n},toHTML:function(n){return n},initialize:function(){},_configure:function(n){var r,f,u;for(this.options&&(n=t.extend({},this.options,n)),r=0,f=i.length;r<f;r++)u=i[r],n[u]&&(this[u]=n[u]);this.options=n},isActive:function(){return document.queryCommandState(this.cmd)},_bindToBlock:function(n){var i=this,t=!1;n.on("keyup",".st-text-block",function(n){(n.which==17||n.which==224||n.which==91)&&(t=!1)}).on("keydown",".st-text-block",{formatter:i},function(n){(n.which==17||n.which==224||n.which==91)&&(t=!0);n.which==n.data.formatter.keyCode&&t===!0&&(document.execCommand(n.data.formatter.cmd,!1,!0),n.preventDefault(),t=!1)})}}),n.extend=f,n}();i.Blocks.Quote=function(){var n=t.template(['<blockquote class="st-required st-text-block" contenteditable="true"><\/blockquote>','<label class="st-input-label"> <%= i18n.t("blocks:quote:credit_field") %><\/label>','<input maxlength="140" name="cite" placeholder="<%= i18n.t("blocks:quote:credit_field") %>"',' class="st-input-string st-required js-cite-input" type="text" />'].join("\n"));return i.Block.extend({type:"quote",title:function(){return i18n.t("blocks:quote:title")},icon_name:"quote",editorHTML:function(){return n(this)},loadData:function(n){this.getTextBlock().html(i.toHTML(n.text,this.type));this.$(".js-cite-input").val(n.cite)},toMarkdown:function(n){return n.replace(/^(.+)$/mg,"> $1")}})}();i.Blocks.Heading=i.Block.extend({type:"Heading",title:function(){return i18n.t("blocks:heading:title")},editorHTML:'<div class="st-required st-text-block st-text-block--heading" contenteditable="true"><\/div>',icon_name:"heading",loadData:function(n){this.getTextBlock().html(i.toHTML(n.text,this.type))}});i.Blocks.Image=i.Block.extend({type:"image",title:function(){return i18n.t("blocks:image:title")},droppable:!0,uploadable:!0,icon_name:"image",loadData:function(t){this.$editor.html(n("<img>",{src:t.file.url}))},onBlockRender:function(){this.$inputs.find("button").bind("click",function(n){n.preventDefault()});this.$inputs.find("input").on("change",t.bind(function(n){this.onDrop(n.currentTarget)},this))},onUploadSuccess:function(n){this.setData(n);this.ready()},onUploadError:function(){this.addMessage(i18n.t("blocks:image:upload_error"));this.ready()},onDrop:function(t){var i=t.files[0],r=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;/image/.test(i.type)&&(this.loading(),this.$inputs.hide(),this.$editor.html(n("<img>",{src:r.createObjectURL(i)})).show(),this.uploader(i,this.onUploadSuccess,this.onUploadError))}});i.Blocks.Text=i.Block.extend({type:"text",title:function(){return i18n.t("blocks:text:title")},editorHTML:'<div class="st-required st-text-block" contenteditable="true"><\/div>',icon_name:"text",loadData:function(n){this.getTextBlock().html(i.toHTML(n.text,this.type))}});i.Blocks.Tweet=function(){var r=t.template(["<blockquote class='twitter-tweet' align='center'>","<p><%= text %><\/p>","&mdash; <%= user.name %> (@<%= user.screen_name %>)","<a href='<%= status_url %>' data-datetime='<%= created_at %>'><%= created_at %><\/a>","<\/blockquote>",'<script src="//platform.twitter.com/widgets.js" charset="utf-8"><\/script>'].join("\n"));return i.Block.extend({type:"tweet",droppable:!0,pastable:!0,fetchable:!0,drop_options:{re_render_on_reorder:!0},title:function(){return i18n.t("blocks:tweet:title")},fetchUrl:function(n){return"/tweets/?tweet_id="+n},icon_name:"twitter",loadData:function(n){t.isUndefined(n.status_url)&&(n.status_url="");this.$inner.find("iframe").remove();this.$inner.prepend(r(n))},onContentPasted:function(t){var i=n(t.target),r=i.val();this.handleTwitterDropPaste(r)},handleTwitterDropPaste:function(n){var r,u;if(!this.validTweetUrl(n)){i.log("Invalid Tweet URL");return}r=n.match(/[^\/]+$/);t.isEmpty(r)||(this.loading(),r=r[0],u={url:this.fetchUrl(r),dataType:"json"},this.fetch(u,this.onTweetSuccess,this.onTweetFail))},validTweetUrl:function(n){return t.isURI(n)&&n.indexOf("twitter")!==-1&&n.indexOf("status")!==-1},onTweetSuccess:function(n){var t={user:{profile_image_url:n.user.profile_image_url,profile_image_url_https:n.user.profile_image_url_https,screen_name:n.user.screen_name,name:n.user.name},id:n.id_str,text:n.text,created_at:n.created_at,entities:n.entities,status_url:"https://twitter.com/"+n.user.screen_name+"/status/"+n.id_str};this.setAndLoadData(t);this.ready()},onTweetFail:function(){this.addMessage(i18n.t("blocks:tweet:fetch_error"));this.ready()},onDrop:function(n){var t=n.getData("text/plain");this.handleTwitterDropPaste(t)}})}();i.Blocks.List=function(){var n='<div class="st-text-block st-required" contenteditable="true"><ul><li><\/li><\/ul><\/div>';return i.Block.extend({type:"list",title:function(){return i18n.t("blocks:list:title")},icon_name:"list",editorHTML:function(){return t.template(n,this)},loadData:function(n){this.getTextBlock().html("<ul>"+i.toHTML(n.text,this.type)+"<\/ul>")},onBlockRender:function(){this.checkForList=t.bind(this.checkForList,this);this.getTextBlock().on("click keyup",this.checkForList)},checkForList:function(){this.$("ul").length===0&&document.execCommand("insertUnorderedList",!1,!1)},toMarkdown:function(n){return n.replace(/<\/li>/mg,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/mg," - $1")},toHTML:function(n){return n.replace(/^ - (.+)$/mg,"<li>$1<\/li>").replace(/\n/mg,"")},onContentPasted:function(n,t){var i=this.pastedMarkdownToHTML(t[0].innerHTML),r=this.$("ul").html(i);this.getTextBlock().caretToEnd()},isEmpty:function(){return t.isEmpty(this.saveAndGetData().text)}})}();i.Blocks.Video=function(){return i.Block.extend({providers:{vimeo:{regex:/(?:http[s]?:\/\/)?(?:www.)?vimeo.com\/(.+)/,html:'<iframe src="{{protocol}}//player.vimeo.com/video/{{remote_id}}?title=0&byline=0" width="580" height="320" frameborder="0"><\/iframe>'},youtube:{regex:/(?:http[s]?:\/\/)?(?:www.)?(?:(?:youtube.com\/watch\?(?:.*)(?:v=))|(?:youtu.be\/))([^&].+)/,html:'<iframe src="{{protocol}}//www.youtube.com/embed/{{remote_id}}" width="580" height="320" frameborder="0" allowfullscreen><\/iframe>'}},type:"video",title:function(){return i18n.t("blocks:video:title")},droppable:!0,pastable:!0,icon_name:"video",loadData:function(n){if(this.providers.hasOwnProperty(n.source)){this.providers[n.source].square?this.$editor.addClass("st-block__editor--with-square-media"):this.$editor.addClass("st-block__editor--with-sixteen-by-nine-media");var t=this.providers[n.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",n.remote_id).replace("{{width}}",this.$editor.width());this.$editor.html(t)}},onContentPasted:function(t){this.handleDropPaste(n(t.target).val())},handleDropPaste:function(n){if(t.isURI(n)){var i,r;t.each(this.providers,function(u,f){i=u.regex.exec(n);i===null||t.isUndefined(i[1])||(r={source:f,remote_id:i[1]},this.setAndLoadData(r))},this)}},onDrop:function(n){var t=n.getData("text/plain");this.handleDropPaste(t)}})}(),function(){var n=i.Formatter.extend({title:"bold",cmd:"bold",keyCode:66,text:"B"}),t=i.Formatter.extend({title:"italic",cmd:"italic",keyCode:73,text:"i"}),r=i.Formatter.extend({title:"link",iconName:"link",cmd:"CreateLink",text:"link",onClick:function(){var n=prompt(i18n.t("general:link"));n&&n.length>0&&(/((ftp|http|https):\/\/.)|mailto(?=\:[-\.\w]+@)/.test(n)||(n="http://"+n),document.execCommand(this.cmd,!1,n))},isActive:function(){var t=window.getSelection(),n;return t.rangeCount>0&&(n=t.getRangeAt(0).startContainer.parentNode),n&&n.nodeName=="A"}}),u=i.Formatter.extend({title:"unlink",iconName:"link",cmd:"unlink",text:"link"});i.Formatters.Bold=new n;i.Formatters.Italic=new t;i.Formatters.Link=new r;i.Formatters.Unlink=new u}();i.BlockControl=function(){var n=function(n,t){this.type=n;this.instance_scope=t;this.block_type=i.Blocks[this.type].prototype;this.can_be_rendered=this.block_type.toolbarEnabled;this._ensureElement()};return t.extend(n.prototype,r,u,i.Events,{tagName:"a",className:"st-block-control",attributes:function(){return{"data-type":this.block_type.type}},render:function(){return this.$el.html('<span class="st-icon">'+t.result(this.block_type,"icon_name")+"<\/span>"+t.result(this.block_type,"title")),this}}),n}();i.BlockControls=function(){var f=function(n,t){this.instance_scope=t;this.available_types=n||[];this._ensureElement();this._bindFunctions();this.initialize()};return t.extend(f.prototype,r,u,i.Events,{bound:["handleControlButtonClick"],block_controls:null,className:"st-block-controls",html:"<a class='st-icon st-icon--close'>"+i18n.t("general:close")+"<\/a>",initialize:function(){var n,t;for(n in this.available_types)i.Blocks.hasOwnProperty(n)&&(t=new i.BlockControl(n,this.instance_scope),t.can_be_rendered&&this.$el.append(t.render().$el));this.$el.delegate(".st-block-control","click",this.handleControlButtonClick)},show:function(){this.$el.addClass("st-block-controls--active");i.EventBus.trigger("block:controls:shown")},hide:function(){this.$el.removeClass("st-block-controls--active");i.EventBus.trigger("block:controls:hidden")},handleControlButtonClick:function(t){t.stopPropagation();this.trigger("createBlock",n(t.currentTarget).attr("data-type"))}}),f}();i.FloatingBlockControls=function(){var f=function(n,t){this.$wrapper=n;this.instance_id=t;this._ensureElement();this._bindFunctions();this.initialize()};return t.extend(f.prototype,r,u,i.Events,{className:"st-block-controls__top",attributes:function(){return{"data-icon":"add"}},bound:["handleBlockMouseOut","handleBlockMouseOver","handleBlockClick","onDrop"],initialize:function(){this.$el.on("click",this.handleBlockClick).dropArea().bind("drop",this.onDrop);this.$wrapper.on("mouseover",".st-block",this.handleBlockMouseOver).on("mouseout",".st-block",this.handleBlockMouseOut).on("click",".st-block--with-plus",this.handleBlockClick)},onDrop:function(r){r.preventDefault();var e=this.$el,u=r.originalEvent.dataTransfer.getData("text/plain"),f=n("#"+u);t.isUndefined(u)||t.isEmpty(f)||e.attr("id")==u||this.instance_id!=f.attr("data-instance")||e.after(f);i.EventBus.trigger("block:reorder:dropped",u)},handleBlockMouseOver:function(t){var i=n(t.currentTarget);i.hasClass("st-block--with-plus")||i.addClass("st-block--with-plus")},handleBlockMouseOut:function(t){var i=n(t.currentTarget);i.hasClass("st-block--with-plus")&&i.removeClass("st-block--with-plus")},handleBlockClick:function(t){t.stopPropagation();var i=n(t.currentTarget);this.trigger("showBlockControls",i)}}),f}();i.FormatBar=function(){var f=function(n){this.options=t.extend({},i.DEFAULTS.formatBar,n||{});this._ensureElement();this._bindFunctions();this.initialize.apply(this,arguments)};return t.extend(f.prototype,r,i.Events,u,{className:"st-format-bar",bound:["onFormatButtonClick","renderBySelection","hide"],initialize:function(){var t,r,u;this.$btns=[];for(t in i.Formatters)i.Formatters.hasOwnProperty(t)&&(r=i.Formatters[t],u=n("<button>",{"class":"st-format-btn st-format-btn--"+t+" "+(r.iconName?"st-icon":""),text:r.text,"data-type":t,"data-cmd":r.cmd}),this.$btns.push(u),u.appendTo(this.$el));this.$b=n(document);this.$el.bind("click",".st-format-btn",this.onFormatButtonClick)},hide:function(){this.$el.removeClass("st-format-bar--is-ready")},show:function(){this.$el.addClass("st-format-bar--is-ready")},remove:function(){this.$el.remove()},renderBySelection:function(){var i=window.getSelection(),r=i.getRangeAt(0),n=r.getBoundingClientRect(),t={};t.top=n.top+20+window.pageYOffset-this.$el.height()+"px";t.left=(n.left+n.right)/2-this.$el.width()/2+"px";this.highlightSelectedButtons();this.show();this.$el.css(t)},highlightSelectedButtons:function(){var n;t.each(this.$btns,function(t){n=i.Formatters[t.attr("data-type")];t.toggleClass("st-format-btn--is-active",n.isActive())},this)},onFormatButtonClick:function(r){r.stopPropagation();var f=n(r.target),u=i.Formatters[f.attr("data-type")];return t.isUndefined(u)?!1:(!t.isUndefined(u.onClick)&&t.isFunction(u.onClick)?u.onClick():document.execCommand(f.attr("data-cmd"),!1,u.param),this.highlightSelectedButtons(),!1)}}),f}();i.Editor=function(){var u=function(n){this.initialize(n)};return t.extend(u.prototype,r,i.Events,{bound:["onFormSubmit","showBlockControls","hideAllTheThings","hideBlockControls","onNewBlockCreated","changeBlockPosition","onBlockDragStart","onBlockDragEnd","removeBlockDragOver","onBlockDropped","createBlock"],events:{"block:reorder:down":"hideBlockControls","block:reorder:dragstart":"onBlockDragStart","block:reorder:dragend":"onBlockDragEnd","block:content:dropped":"removeBlockDragOver","block:reorder:dropped":"onBlockDropped","block:create:new":"onNewBlockCreated"},initialize:function(n){if(i.log("Init SirTrevor.Editor"),this.blockTypes={},this.blockCounts={},this.blocks=[],this.errors=[],this.options=t.extend({},i.DEFAULTS,n||{}),this.ID=t.uniqueId("st-editor-"),!this._ensureAndSetElements())return!1;!t.isUndefined(this.options.onEditorRender)&&t.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender);this._setRequired();this._setBlocksTypes();this._bindFunctions();this.store("create");i.instances.push(this);this.build();i.bindFormSubmit(this.$form)},build:function(){this.$el.hide();this.block_controls=new i.BlockControls(this.blockTypes,this.ID);this.fl_block_controls=new i.FloatingBlockControls(this.$wrapper,this.ID);this.formatBar=new i.FormatBar(this.options.formatBar);this.listenTo(this.block_controls,"createBlock",this.createBlock);this.listenTo(this.fl_block_controls,"showBlockControls",this.showBlockControls);this._setEvents();i.EventBus.on(this.ID+":blocks:change_position",this.changeBlockPosition);i.EventBus.on("formatter:positon",this.formatBar.renderBySelection);i.EventBus.on("formatter:hide",this.formatBar.hide);this.$wrapper.prepend(this.fl_block_controls.render().$el);n(document.body).append(this.formatBar.render().$el);this.$outer.append(this.block_controls.render().$el);n(window).bind("click",this.hideAllTheThings);var r=this.store("read");r.data.length>0?t.each(r.data,function(n){i.log("Creating: "+n.type);this.createBlock(n.type,n.data)},this):this.options.defaultType!==!1&&this.createBlock(this.options.defaultType,{});this.$wrapper.addClass("st-ready");t.isUndefined(this.onEditorRender)||this.onEditorRender()},destroy:function(){this.formatBar.destroy();this.fl_block_controls.destroy();this.block_controls.destroy();t.each(this.blocks,function(n){this.removeBlock(n.blockID)},this);this.stopListening();var n=this.$el.detach();i.instances=t.reject(i.instances,t.bind(function(n){return n.ID==this.ID},this));this.store("reset");this.$outer.replaceWith(n)},reinitialize:function(n){this.destroy();this.initialize(n||this.options)},_setEvents:function(){t.each(this.events,function(n,t){i.EventBus.on(t,this[n],this)},this)},hideAllTheThings:function(){this.block_controls.hide();this.formatBar.hide();t.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls")},showBlockControls:function(n){t.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls");this.block_controls.show();n.append(this.block_controls.$el.detach());n.addClass("with-st-controls");this.block_controls.current_container=n},store:function(n,t){return i.editorStore(this,n,t||{})},createBlock:function(n,r){if(n=t.classify(n),this._blockLimitReached())return i.log("Cannot add any more blocks. Limit reached."),!1;if(!this._isBlockTypeAvailable(n))return i.log("Block type not available "+n),!1;if(!this._canAddBlockType(n))return i.log("Block Limit reached for type "+n),!1;var u=new i.Blocks[n](r,this.ID);this._renderInPosition(u.render().$el);this.listenTo(u,"removeBlock",this.removeBlock);this.blocks.push(u);this._incrementBlockTypeCount(n);u.focus();i.EventBus.trigger(r?"block:create:existing":"block:create:new",u);i.log("Block created of type "+n);u.trigger("onRender");this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached());this.triggerBlockCountUpdate()},onNewBlockCreated:function(n){this.hideBlockControls();this.scrollTo(n.$el)},scrollTo:function(t){n("html, body").animate({scrollTop:t.position().top},300,"linear")},blockFocus:function(){this.block_controls.current_container=null},hideBlockControls:function(){t.isUndefined(this.block_controls.current_container)||this.block_controls.current_container.removeClass("with-st-controls");this.block_controls.hide()},removeBlockDragOver:function(){this.$outer.find(".st-drag-over").removeClass("st-drag-over")},triggerBlockCountUpdate:function(){i.EventBus.trigger(this.ID+":blocks:count_update",this.blocks.length)},changeBlockPosition:function(n,t){t=t-1;var r=this.getBlockPosition(n),i=this.$wrapper.find(".st-block").eq(t),f=this.getBlockPosition(i),u=r>t?"Before":"After";i&&i.attr("id")!==n.attr("id")&&(this.hideAllTheThings(),n["insert"+u](i),this.scrollTo(n))},onBlockDropped:function(n){this.hideAllTheThings();var i=this.findBlockById(n);t.isUndefined(i)||t.isEmpty(i.getData())||!i.drop_options.re_render_on_reorder||i.beforeLoadingData()},onBlockDragStart:function(){this.hideBlockControls();this.$wrapper.addClass("st-outer--is-reordering")},onBlockDragEnd:function(){this.removeBlockDragOver();this.$wrapper.removeClass("st-outer--is-reordering")},_renderInPosition:function(n){this.block_controls.current_container?this.block_controls.current_container.after(n):this.$wrapper.append(n)},_incrementBlockTypeCount:function(n){this.blockCounts[n]=t.isUndefined(this.blockCounts[n])?1:this.blockCounts[n]+1},_getBlockTypeCount:function(n){return t.isUndefined(this.blockCounts[n])?0:this.blockCounts[n]},_canAddBlockType:function(n){var t=this._getBlockTypeLimit(n);return!(t!==0&&this._getBlockTypeCount(n)>=t)},_blockLimitReached:function(){return this.options.blockLimit!==0&&this.blocks.length>=this.options.blockLimit},removeBlock:function(n){var r=this.findBlockById(n),u=t.classify(r.type),f=r.$el.find(".st-block-controls");f.length&&(this.block_controls.hide(),this.$wrapper.prepend(f));this.blockCounts[u]=this.blockCounts[u]-1;this.blocks=t.reject(this.blocks,function(n){return n.blockID==r.blockID});this.stopListening(r);r.remove();i.EventBus.trigger("block:remove",r);this.triggerBlockCountUpdate();this.$wrapper.toggleClass("st--block-limit-reached",this._blockLimitReached())},performValidations:function(n,r){var u=0;return!i.SKIP_VALIDATION&&r&&(n.valid()||(this.errors.push({text:t.result(n,"validationFailMsg")}),i.log("Block "+n.blockID+" failed validation"),++u)),u},saveBlockStateToStore:function(n){var r=n.saveAndReturnData();r&&!t.isEmpty(r.data)&&(i.log("Adding data for block "+n.blockID+" to block store"),this.store("add",{data:r}))},onFormSubmit:function(n){return n=n===!1?!1:!0,i.log("Handling form submission for Editor "+this.ID),this.removeErrors(),this.store("reset"),this.validateBlocks(n),this.validateBlockTypesExist(n),this.renderErrors(),this.store("save"),this.errors.length},validateBlocks:function(r){if(!this.required&&i.SKIP_VALIDATION&&!r)return!1;var u=function(i){var u=t.find(this.blocks,function(t){return t.blockID==n(i).attr("id")});if(t.isUndefined(u))return!1;this.performValidations(u,r);this.saveBlockStateToStore(u)};t.each(this.$wrapper.find(".st-block"),u,this)},validateBlockTypesExist:function(n){if(!this.required&&i.SKIP_VALIDATION&&!n)return!1;var r=function(n){if(this._isBlockTypeAvailable(n))if(this._getBlockTypeCount(n)===0)i.log("Failed validation on required block type "+n),this.errors.push({text:i18n.t("errors:type_missing",{type:n})});else{var r=t.filter(this.getBlocksByType(n),function(n){return!n.isEmpty()});if(r.length>0)return!1;this.errors.push({text:i18n.t("errors:required_type_empty",{type:n})});i.log("A required block type "+n+" is empty")}};t.isArray(this.required)&&t.each(this.required,r,this)},renderErrors:function(){if(this.errors.length===0)return!1;t.isUndefined(this.$errors)&&(this.$errors=this._errorsContainer());var n="<ul>";t.each(this.errors,function(t){n+='<li class="st-errors__msg">'+t.text+"<\/li>"});n+="<\/ul>";this.$errors.append(n);this.$errors.show()},_errorsContainer:function(){if(t.isUndefined(this.options.errorsContainer)){var i=n("<div>",{"class":"st-errors",html:"<p>"+i18n.t("errors:title")+" <\/p>"});return this.$outer.prepend(i),i}return e(this.options.errorsContainer)},removeErrors:function(){if(this.errors.length===0)return!1;this.$errors.hide().find("ul").html("");this.errors=[]},findBlockById:function(n){return t.find(this.blocks,function(t){return t.blockID==n})},getBlocksByType:function(n){return t.filter(this.blocks,function(i){return t.classify(i.type)==n})},getBlocksByIDs:function(n){return t.filter(this.blocks,function(i){return t.contains(n,i.blockID)})},getBlockPosition:function(n){return this.$wrapper.find(".st-block").index(n)},_getBlockTypeLimit:function(n){return this._isBlockTypeAvailable(n)?parseInt(t.isUndefined(this.options.blockTypeLimits[n])?0:this.options.blockTypeLimits[n],10):0},_isBlockTypeAvailable:function(n){return!t.isUndefined(this.blockTypes[n])},_ensureAndSetElements:function(){if(t.isUndefined(this.options.el)||t.isEmpty(this.options.el))return i.log("You must provide an el"),!1;this.$el=this.options.el;this.el=this.options.el[0];this.$form=this.$el.parents("form");var r=n("<div>").attr({id:this.ID,"class":"st-outer",dropzone:"copy link move"}),u=n("<div>").attr({"class":"st-blocks"});return this.$el.wrap(r).wrap(u),this.$outer=this.$form.find("#"+this.ID),this.$wrapper=this.$outer.find(".st-blocks"),!0},_setBlocksTypes:function(){this.blockTypes=t.flattern(t.isUndefined(this.options.blockTypes)?i.Blocks:this.options.blockTypes)},_setRequired:function(){this.required=t.isArray(this.options.required)&&!t.isEmpty(this.options.required)?this.options.required:!1}}),u}();i.setDefaults=function(n){i.DEFAULTS=t.extend(i.DEFAULTS,n||{})};i.bindFormSubmit=function(n){o||(new i.Submittable(n),n.bind("submit",this.onFormSubmit),o=!0)};i.onBeforeSubmit=function(n){var r=0;return t.each(i.instances,function(t){r+=t.onFormSubmit(n)}),i.log("Total errors: "+r),r};i.onFormSubmit=function(n){var t=i.onBeforeSubmit();t>0&&(i.EventBus.trigger("onError"),n.preventDefault())};i.getInstance=function(n){return t.isUndefined(n)?this.instances[0]:t.isString(n)?t.find(this.instances,function(t){return t.ID===n}):this.instances[n]};i.setBlockOptions=function(n,r){var u=i.Blocks[n];t.isUndefined(u)||t.extend(u.prototype,r||{})};i.runOnAllInstances=function(n){t.has(i.Editor.prototype,n)?([].unshift.call(arguments,i.instances),t.invoke.apply(t,arguments)):i.log("method doesn't exist")}})(jQuery,_);
/*
//# sourceMappingURL=sir-trevor.min.js.map
*/